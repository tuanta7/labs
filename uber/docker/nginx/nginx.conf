# Events block: Configures connection processing
# This is required in every NGINX configuration
events {
    # Maximum number of simultaneous connections that can be opened by a worker process
    worker_connections 1024;
}

# HTTP block: Contains all HTTP-related configuration
http {
    # Upstream block: Defines a group of backend servers for load balancing
    # "ingestion" is the name we'll use to reference this group
    upstream ingestion {
        # Load balancing method: Routes to server with least active connections
        # Other options: round_robin (default), ip_hash, random
        least_conn;

        # Backend servers in the pool
        # Requests will be distributed between these two servers
        server ingestion-1:8080;
        server ingestion-2:8080;
    }

    # Upstream for location service (single server, no load balancing needed)
    upstream location {
        server location:8080;
    }

    # Upstream for driver service (single server, no load balancing needed)
    upstream driver {
        server driver:8080;
    }

    # Server block: Defines a virtual server that handles requests
    server {
        # Listen on port 80 (standard HTTP port)
        listen 80;

        # Location block for WebSocket connections
        # ^~ modifier means: if this matches, stop searching for other locations
        # This ensures WebSocket requests don't match the generic /ingestion/ location below
        location ^~ /ingestion/ws {
            # Rewrite the URL: /ingestion/ws becomes /ws before passing to backend
            # Example: /ingestion/ws/connect -> /ws/connect
            rewrite ^/ingestion/(.*) /$1 break;

            # Forward request to the "ingestion" upstream group defined above
            proxy_pass http://ingestion;

            # WebSocket-specific configuration
            # Use HTTP/1.1 (required for WebSocket)
            proxy_http_version 1.1;

            # Pass the Upgrade header from client to backend (required for WebSocket)
            proxy_set_header Upgrade $http_upgrade;

            # Set Connection header to "Upgrade" (required for WebSocket handshake)
            proxy_set_header Connection "Upgrade";

            # Forward original request headers to backend
            # Host: The original host requested by the client
            proxy_set_header Host $host;

            # X-Real-IP: The real IP address of the client
            proxy_set_header X-Real-IP $remote_addr;

            # X-Forwarded-For: Chain of IP addresses the request passed through
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Disable buffering for WebSocket (enables real-time communication)
            proxy_buffering off;

            # Timeout settings: How long to wait before closing idle connections
            # 1h = 1 hour (WebSocket connections can be long-lived)
            proxy_read_timeout 1h;
            proxy_send_timeout 1h;
        }

        # Location block for regular ingestion HTTP requests
        # Any request starting with /ingestion/ will match here
        location /ingestion/ {
            # Remove /ingestion prefix before forwarding
            # Example: /ingestion/api/data -> /api/data
            rewrite ^/ingestion/(.*) /$1 break;

            # Forward to the ingestion upstream (load balanced)
            proxy_pass http://ingestion;
        }

        # Location block for location service
        location /location/ {
            # Remove /location prefix before forwarding
            # Example: /location/coordinates -> /coordinates
            rewrite ^/location/(.*) /$1 break;

            # Forward to the location upstream
            proxy_pass http://location;
        }

        # Location block for driver service
        location /driver/ {
            # Remove /driver prefix before forwarding
            # Example: /driver/profile -> /profile
            rewrite ^/driver/(.*) /$1 break;

            # Forward to the driver upstream
            proxy_pass http://driver;
        }
    }
}